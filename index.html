// === [โค้ดใหม่] ส่วนที่ 2: ระบบควบคุมการเข้าถึงและนับถอยหลัง ===
    <script>
        // === ส่วนที่ 1: โค้ดคำนวณเดิมของคุณ (ไม่มีการแก้ไข) ===
        document.addEventListener('DOMContentLoaded', () => {
            // ... (โค้ดคำนวณเดิมทั้งหมดของคุณ) ...
            
            // --- โค้ดส่วน initApp เดิม ---
            function initApp() {
                // ... (โค้ด initApp เดิม) ...
            }

            initApp();
        });

        
        // --- ส่วนที่ 2: ระบบควบคุมการเข้าถึงและนับถอยหลัง (อัปเดตและแก้ไขแล้ว) ---
        
        // ฟังก์ชันช่วย: รับ/สร้าง Client ID จาก LocalStorage
        function getClientId() {
            let clientId = localStorage.getItem('client_id');
            if (!clientId) {
                // สร้าง ID ใหม่ที่ไม่ซ้ำกัน
                // ใช้รูปแบบที่ง่ายต่อการจัดเก็บและดึงข้อมูล
                clientId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                localStorage.setItem('client_id', clientId);
            }
            return clientId;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const paymentOverlay = document.getElementById('payment-overlay');
            const paymentModalContent = document.getElementById('payment-modal-content');
            const countdownTimerDiv = document.getElementById('countdown-timer');
            const timerDisplaySpan = document.getElementById('timer-display');
            const trialBtn = document.getElementById('trial-btn');
            const trialMessage = document.getElementById('trial-message');
            const trialBtnText = document.getElementById('trial-btn-text');
            const trialBtnSpinner = document.getElementById('trial-btn-spinner');
            
            let countdownInterval;

            // ฟังก์ชันสำหรับ "ล็อค" แอปพลิเคชัน
            function lockApp() {
                if (countdownInterval) clearInterval(countdownInterval);
                localStorage.removeItem('app_expires_at');
                paymentOverlay.classList.add('visible');
                setTimeout(() => {
                    paymentModalContent.classList.remove('scale-95', 'opacity-0');
                }, 10);
                countdownTimerDiv.style.display = 'none';
            }

            // ฟังก์ชันสำหรับ "ปลดล็อค" แอปพลิเคชัน
            function unlockApp(expiryDateString) {
                localStorage.setItem('app_expires_at', expiryDateString);
                paymentModalContent.classList.add('scale-95', 'opacity-0');
                paymentOverlay.classList.remove('visible');
                startCountdown(expiryDateString);
            }

            // ฟังก์ชันเริ่มนับถอยหลัง
            function startCountdown(expiryDateString) {
                if (countdownInterval) clearInterval(countdownInterval);

                const expiryTime = new Date(expiryDateString).getTime();
                countdownTimerDiv.style.display = 'block';

                countdownInterval = setInterval(() => {
                    const now = new Date().getTime();
                    const distance = expiryTime - now;

                    if (distance < 0) {
                        lockApp();
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    timerDisplaySpan.textContent = `${days} วัน ${hours} ชั่วโมง ${minutes} นาที ${seconds} วินาที`;
                }, 1000);
            }

            // ฟังก์ชันขอทดลองใช้ (เรียก Netlify Function)
            async function requestTrial() {
                trialBtn.disabled = true;
                trialBtnText.classList.add('hidden');
                trialBtnSpinner.classList.remove('hidden');
                trialMessage.textContent = '';
                
                const clientId = getClientId(); // ดึง Client ID

                try {
                    const response = await fetch('/.netlify/functions/request-trial', {
                        method: 'POST',
                        headers: {
                            // *** แก้ไข: กำหนด Content-Type เป็น JSON ***
                            'Content-Type': 'application/json',
                        },
                        // *** แก้ไข: ส่ง client_id ในรูปแบบ JSON ***
                        body: JSON.stringify({ client_id: clientId }) 
                    });

                    const result = await response.json();

                    if (result.success) {
                        // ถ้าสำเร็จ ให้ปลดล็อคและแสดงข้อความ
                        unlockApp(result.expires_at);
                        trialMessage.textContent = result.message;
                        trialMessage.classList.remove('text-red-500');
                        trialMessage.classList.add('text-green-600');
                    } else {
                        // ถ้าไม่สำเร็จ (เช่น ใช้สิทธิ์ไปแล้ว)
                        trialMessage.textContent = result.message || 'เกิดข้อผิดพลาด';
                        trialMessage.classList.add('text-red-500');
                        trialMessage.classList.remove('text-green-600');
                        
                        // ถ้าข้อความแจ้งว่าเคยใช้แล้วแต่มี expires_at กลับมา
                        if(result.expires_at) {
                            unlockApp(result.expires_at);
                        }
                    }
                } catch (error) {
                    console.error("Function Call Error:", error);
                    trialMessage.textContent = 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ (โปรดตรวจสอบ Network)';
                    trialMessage.classList.add('text-red-500');
                } finally {
                    trialBtn.disabled = false;
                    trialBtnText.classList.remove('hidden');
                    trialBtnSpinner.classList.add('hidden');
                }
            }
            
            // --- Controller หลัก เมื่อหน้าเว็บโหลดเสร็จ ---
            const expiryDate = localStorage.getItem('app_expires_at');

            // ตรวจสอบว่าเคยเปิดใช้งานและยังไม่หมดอายุหรือไม่
            if (expiryDate && new Date(expiryDate).getTime() > new Date().getTime()) {
                unlockApp(expiryDate); // ถ้ามีเวลาเหลือ ก็ปลดล็อค
            } else {
                lockApp(); // ถ้าไม่มี หรือหมดอายุแล้ว ก็ล็อคไว้
            }
            
            // เพิ่ม Event Listener ให้ปุ่มทดลองใช้
            trialBtn.addEventListener('click', requestTrial);
        });
    </script>
</body>
</html>
